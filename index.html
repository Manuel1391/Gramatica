 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prepositions Quiz Board</title>
  <style>
    :root {
        --card-bg: #1e293b;
        --card-border: #334155;
        --accent: #3b82f6;
        --text-color: #f8fafc;
        --bg-color: #0f172a;
        --muted-text: #94a3b8;
        --correct-color: #4ade80;
        --wrong-color: #f87171;
        --option-bg: #334155;
        --feedback-bg: #1e293b;
    }

    body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
        background: var(--bg-color); 
        margin: 0; 
        padding: 20px; 
        color: var(--text-color)
    }
    
    header {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 16px
    }
    
    h1 {
        font-size: 18px;
        margin: 0
    }
    
    .controls {
        margin-left: auto;
        display: flex;
        gap: 8px;
        align-items: center
    }
    
    .btn {
        background: var(--option-bg);
        border: 1px solid var(--card-border);
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-color)
    }
    
    .btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: transparent
    }
    
    .btn.ghost {
        background: transparent
    }
    
    .selector {
        display: flex;
        gap: 6px
    }
    
    .stats {
        font-size: 14px;
        color: var(--muted-text)
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px
    }
    
    .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease
    }
    
    .card.answered {
        background-color: #1e40af;
        border-color: var(--accent)
    }
    
    .situation {
        font-weight: 600;
        margin-bottom: 10px
    }
    
    .controls-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center
    }
    
    textarea.answer {
        width: 100%;
        min-height: 56px;
        border: 1px solid var(--card-border);
        padding: 8px;
        border-radius: 8px;
        margin-top: 8px;
        resize: vertical;
        background: var(--card-bg);
        color: var(--text-color)
    }
    
    .options {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 8px
    }
    
    .option-btn {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #475569;
        background: var(--option-bg);
        text-align: left;
        cursor: pointer;
        color: var(--text-color)
    }
    
    .option-btn.correct {
        border-color: var(--correct-color);
        background: rgba(74, 222, 128, 0.1)
    }
    
    .option-btn.wrong {
        border-color: var(--wrong-color);
        background: rgba(248, 113, 113, 0.1)
    }
    
    .feedback {
        margin-top: 10px;
        font-size: 14px
    }
    
    .explain {
        margin-top: 6px;
        padding: 8px;
        background: var(--feedback-bg);
        border-radius: 8px;
        border: 1px solid var(--card-border)
    }
    
    .ipa {
        font-family: monospace;
        margin-top: 6px;
        color: var(--muted-text)
    }
    
    footer {
        margin-top: 18px;
        color: var(--muted-text);
        font-size: 13px
    }
    
    .small {
        font-size: 13px;
        color: var(--muted-text)
    }

    .explanation {
        white-space: pre-wrap;
        color: var(--text-color)
    }
</style>
</head>
<body>
  <header>
    <div>
      <h1>Prepositions Quiz Board</h1>
      <div class="small">Practice forming full sentences and choosing the correct preposition (on / in / at / etc.). Data loads from a Google Sheet CSV.</div>
    </div>

    <div class="controls">
      <div class="selector">
        <button class="btn" data-count="10">10</button>
        <button class="btn" data-count="20">20</button>
        <button class="btn" data-count="50">50</button>
      </div>
      <button id="shuffleBtn" class="btn">Shuffle</button>
      <button id="reloadBtn" class="btn">Reload</button>
      <div class="stats" id="stats">Loaded: 0 • Selected: 0 • Correct: 0</div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid"></div>
  </main>

  <footer>
    <div>Sheet source: <span id="sheetUrl"></span></div>
    <div style="margin-top:6px">Progress is stored locally in your browser. To reset, click Reload.</div>
  </footer>

<script>
// Configuration
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxbOVzYghRBcRrgFSw_QIMx9mYnNaMuGOXWwIefMJjL_BRuWCp2QdlP7IitxTHu7nb-9TW6WH6tZSl/pub?output=csv';
const STORAGE_KEY = 'prepositions_quiz_progress_' + btoa(CSV_URL).slice(0,12);

document.getElementById('sheetUrl').textContent = CSV_URL;

// Utility: CSV parser that handles quoted fields (simple implementation)
function parseCSV(text){
  const rows = [];
  let cur = [];
  let i = 0; let field = ''; let inQuotes = false;
  while(i < text.length){
    const ch = text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ field += '"'; i+=2; continue; }
        inQuotes = false; i++; continue;
      }
      field += ch; i++; continue;
    }
    if(ch === '"'){ inQuotes = true; i++; continue; }
    if(ch === ','){ cur.push(field); field=''; i++; continue; }
    if(ch === '\r'){ i++; continue; }
    if(ch === '\n'){ cur.push(field); rows.push(cur); cur=[]; field=''; i++; continue; }
    field += ch; i++;
  }
  // last field
  if(field !== '' || cur.length){ cur.push(field); rows.push(cur); }
  return rows;
}

function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}

// Load CSV
async function loadData(){
  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error('CSV fetch failed: ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    // Assume header row exists; map columns by header name (case-insensitive)
    const header = rows[0].map(h=>h.trim().toLowerCase());
    const data = rows.slice(1).map(r=>{
      const obj = {};
      for(let i=0;i<header.length;i++) obj[header[i]] = (r[i]||'').trim();
      return obj;
    }).filter(o => o.situation && o.correctanswer);
    return data;
  }catch(err){ console.error(err); alert('Error loading CSV: '+err.message); return []; }
}

// Local storage helpers
function saveProgress(progress){ localStorage.setItem(STORAGE_KEY, JSON.stringify(progress)); }
function loadProgress(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(e){return{};} }

// Render
let allData = [], selectedRows = [], progress = loadProgress();
const gridEl = document.getElementById('grid');
const statsEl = document.getElementById('stats');

function updateStats(){
  const correct = Object.values(progress).filter(v=>v.correct).length;
  statsEl.textContent = `Loaded: ${allData.length} • Selected: ${selectedRows.length} • Correct: ${correct}`;
}


function makeCard(row, index) {
  const card = document.createElement('div'); 
  card.className = 'card';
  card.dataset.index = index;

  // Marcar como respondida si ya está en el progreso
  if (progress[row._uid]) {
    card.classList.add('answered');
  }

  const situ = document.createElement('div'); 
  situ.className = 'situation'; 
  situ.textContent = row.situation || '(no situation)';
  card.appendChild(situ);

  const controlsRow = document.createElement('div'); 
  controlsRow.className = 'controls-row';
  card.appendChild(controlsRow);

  const showBtn = document.createElement('button'); 
  showBtn.className = 'btn primary'; 
  showBtn.textContent = 'Show options';
  controlsRow.appendChild(showBtn);

  const hideBtn = document.createElement('button');
  hideBtn.className = 'btn';
  hideBtn.textContent = 'Hide options';
  hideBtn.style.display = 'none';
  controlsRow.appendChild(hideBtn);

  const optionsDiv = document.createElement('div'); 
  optionsDiv.className = 'options'; 
  optionsDiv.style.display = 'none';
  card.appendChild(optionsDiv);

  const feedback = document.createElement('div'); 
  feedback.className = 'feedback';
  card.appendChild(feedback);

  function buildOptions() {
    optionsDiv.innerHTML = '';
    const candidates = [row.correctanswer, row.distractor1||'', row.distractor2||'', row.distractor3||''].filter(Boolean);
    const opts = shuffleArray(candidates.slice());
    opts.forEach(opt => {
      const b = document.createElement('button'); 
      b.className = 'option-btn'; 
      b.textContent = opt; 
      b.dataset.val = opt;
      b.addEventListener('click', () => {
        Array.from(optionsDiv.querySelectorAll('button')).forEach(btn => btn.disabled = true);
        const isCorrect = opt === row.correctanswer;
        progress[row._uid] = { chosen: opt, correct: isCorrect };
        saveProgress(progress);
        showFeedback(isCorrect, opt, b);
        updateStats();
      });
      optionsDiv.appendChild(b);
    });
  }

  function showFeedback(isCorrect, chosen, clickedBtn) {
    feedback.innerHTML = '';
    const mark = document.createElement('div'); 
    mark.textContent = isCorrect ? '✅ Correct' : '❌ Incorrect';
    feedback.appendChild(mark);
    
    Array.from(optionsDiv.querySelectorAll('button')).forEach(btn => {
      if(btn.dataset.val === row.correctanswer) btn.classList.add('correct');
      if(btn.dataset.val === chosen && !isCorrect) btn.classList.add('wrong');
    });
    
    const expl = document.createElement('div');
    expl.className = 'explanation';
    expl.innerHTML = (row.explanation || '');
    feedback.appendChild(expl);

    if (row.ipa) {
      const ipa = document.createElement('div');
      ipa.className = 'ipa';
      ipa.textContent = 'IPA: ' + row.ipa;
      feedback.appendChild(ipa);
    }
    
    // Mostrar el botón Hide options solo si la respuesta es correcta
    if(isCorrect) {
      hideBtn.style.display = 'block';
      showBtn.style.display = 'none';
    }
  }

  // Evento para el botón Hide options
  hideBtn.addEventListener('click', () => {
    optionsDiv.style.display = 'none';
    feedback.style.display = 'none';
    hideBtn.style.display = 'none';
    showBtn.style.display = 'block';
    
    // Marcar la tarjeta como respondida y moverla al final
    card.classList.add('answered');
    gridEl.appendChild(card);
  });

  // Evento para el botón Show options
  showBtn.addEventListener('click', () => { 
    if(optionsDiv.style.display === 'none') {
      buildOptions(); 
      optionsDiv.style.display = 'flex';
      feedback.style.display = 'block';
    } else { 
      optionsDiv.style.display = 'none'; 
    }
  });

  // Restaurar progreso si existe
  if(progress[row._uid]) {
    buildOptions(); 
    optionsDiv.style.display = 'flex';
    Array.from(optionsDiv.querySelectorAll('button')).forEach(b => b.disabled = true);
    showFeedback(progress[row._uid].correct, progress[row._uid].chosen);
    
    // Si ya estaba respondida correctamente, ocultar el botón Show options
    if(progress[row._uid].correct) {
      showBtn.style.display = 'none';
      hideBtn.style.display = 'block';
    }
  }

  return card;
}

// prepare rows with unique ids
function prepareData(raw){
  return raw.map((r,idx)=>({...r, _uid: r.correctanswer + '||' + idx}));
}

function renderBoard(count){
  gridEl.innerHTML='';
  if(allData.length===0) return;
  // select random subset
  const pool = shuffleArray(allData.slice());
  selectedRows = pool.slice(0, Math.min(count, pool.length));
  selectedRows.forEach((row, i)=> gridEl.appendChild(makeCard(row, i)));
  updateStats();
}

// initial load
(async function init(){
  allData = prepareData(await loadData());
  updateStats();
  // default load 10 or less
  const defaultCount = Math.min(10, allData.length);
  renderBoard(defaultCount);
})();

// controls
document.querySelectorAll('[data-count]').forEach(btn=>btn.addEventListener('click', ()=>{
  const n = parseInt(btn.dataset.count,10);
  renderBoard(n);
}));

document.getElementById('shuffleBtn').addEventListener('click', ()=>{
  renderBoard(selectedRows.length || 10);
});

document.getElementById('reloadBtn').addEventListener('click', async ()=>{
  if(confirm('Reload data from sheet and reset progress?')){
    localStorage.removeItem(STORAGE_KEY);
    progress = {};
    allData = prepareData(await loadData());
    renderBoard(Math.min(10, allData.length));
  }
});

</script>
</body>
</html>